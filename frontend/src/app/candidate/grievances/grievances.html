<div class="grievances-container">
  <!-- Page Header -->
  <header class="page-header">
    <div class="header-content">
        <h1><i class="bi bi-shield-exclamation"></i> Grievances & Support</h1>
        <p>Submit and track your concerns. We're here to help resolve any issues.</p>
    </div>
    <div class="header-actions">
      <!-- Button to open the submission modal -->
      <button class="submit-grievance-btn" (click)="openSubmitModal()">
        <i class="bi bi-plus-lg"></i> Submit Grievance
      </button>
    </div>
  </header>

  <!-- Filter Controls -->
  <div class="controls-bar">
    <div class="status-filters">
      <button *ngFor="let filter of ['All Grievances', 'Submitted', 'In Review', 'Resolved', 'Closed']"
              [class.active]="activeFilter === filter"
              (click)="setFilter(filter)">
        {{ filter }} <span class="filter-count">{{ filterCounts[filter] || 0 }}</span>
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-state">
    <i class="bi bi-hourglass-split"></i>
    <p>Loading your grievances...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !isLoading" class="error-state">
    <i class="bi bi-exclamation-triangle"></i>
    <p>{{ error }}</p>
    <button class="retry-btn" (click)="loadGrievances()">Try Again</button>
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading && !error && filteredGrievances.length === 0" class="empty-state">
    <div class="empty-state-content">
      <i class="bi bi-shield-exclamation"></i>
      <h3>No grievances found</h3>
      <p>There are no submitted grievances. Click the button above to submit your first grievance.</p>
    </div>
  </div>

  <!-- Grievances List -->
  <div class="grievance-list" *ngIf="!isLoading && !error && filteredGrievances.length > 0">
    <div class="grievance-card" *ngFor="let g of filteredGrievances">
      <div class="card-main">
        <div class="card-header">
          <h3 class="grievance-title">{{ g.title }}</h3>
          <div class="grievance-tags">
            <span class="priority-tag" [ngClass]="getPriorityClass(g.priority)">{{ g.priority }}</span>
            <span class="status-tag" [ngClass]="getStatusClass(g.status)">{{ g.status }}</span>
          </div>
        </div>
        <div class="grievance-meta">
          <span>Submitted: {{ formatDate(g.createdDate) }}</span> &bull;
          <span>By: User #{{ g.submittedBy }}</span>
          <span *ngIf="g.attachmentFileName" class="attachment-indicator">
            <i class="bi bi-paperclip"></i> Attachment
          </span>
        </div>
        <p class="grievance-description">{{ g.description }}</p>
      </div>
      <div class="card-actions">
        <button class="view-details-btn" (click)="openDetailsModal(g)">View Details</button>
        <button class="delete-btn" (click)="deleteGrievance(g)" title="Delete Grievance">
          <i class="bi bi-trash"></i> Delete
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ======================================================================= -->
<!--                            MODALS START HERE                             -->
<!-- ======================================================================= -->

<!-- Modal 1: Submit a Grievance -->
<div class="modal-overlay" *ngIf="isSubmitModalVisible" (click)="closeSubmitModal()">
  <div class="modal-content submit-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">Submit a Grievance</h2>
      <button class="modal-close-btn" (click)="closeSubmitModal()"><i class="bi bi-x"></i></button>
    </div>
    <p class="modal-subtitle">Describe your concern and we'll help resolve it.</p>
    <form class="grievance-form" (ngSubmit)="submitGrievance()">
      <div class="form-group">
        <label for="title">Title *</label>
        <input type="text" id="title" [(ngModel)]="grievanceForm.title" name="title"
               placeholder="Brief summary of your issue" required>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="category">Category</label>
          <select id="category" [(ngModel)]="grievanceForm.category" name="category">
            <option value="Other">Other</option>
            <option value="Application Related">Application Related</option>
            <option value="Technical Issue">Technical Issue</option>
            <option value="Discrimination">Discrimination</option>
            <option value="Company Related">Company Related</option>
          </select>
        </div>
        <div class="form-group">
          <label for="priority">Priority</label>
          <select id="priority" [(ngModel)]="grievanceForm.priority" name="priority">
            <option value="Low">Low</option>
            <option value="Medium">Medium</option>
            <option value="High">High</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label for="description">Description *</label>
        <textarea id="description" [(ngModel)]="grievanceForm.description" name="description"
                  rows="4" placeholder="Please provide detailed information about your issue..." required></textarea>
      </div>
      <div class="form-group">
        <label for="file-upload">Attachments (Optional)</label>
        <div class="file-upload-container">
          <input
            type="file"
            id="file-upload"
            class="file-input"
            (change)="onFileSelected($event)"
            accept=".png,.jpg,.jpeg,.pdf,.doc,.docx"
            style="display: none;">
          <label for="file-upload" class="file-drop-area" [class.file-selected]="selectedFile">
            <div class="upload-content">
              <i class="bi bi-cloud-arrow-up" *ngIf="!selectedFile"></i>
              <i class="bi bi-file-earmark-check" *ngIf="selectedFile"></i>
              <div class="upload-text">
                <span *ngIf="!selectedFile">Click to upload or drag and drop</span>
                <span *ngIf="selectedFile">{{ selectedFile.name }}</span>
              </div>
              <small class="upload-hint" *ngIf="!selectedFile">PNG, JPG, PDF, DOC up to 10MB each</small>
              <small class="file-size" *ngIf="selectedFile">({{ (selectedFile.size / 1024 / 1024).toFixed(2) }} MB)</small>
            </div>
          </label>
        </div>
        <div *ngIf="selectedFile" class="selected-file-actions">
          <button type="button" class="remove-file-btn" (click)="selectedFile = null" title="Remove file">
            <i class="bi bi-x"></i> Remove
          </button>
        </div>
      </div>
      <div class="form-actions">
        <button type="button" class="cancel-btn" (click)="closeSubmitModal()" [disabled]="isSubmitting">Cancel</button>
        <button type="submit" class="submit-btn" [disabled]="!grievanceForm.title.trim() || !grievanceForm.description.trim() || isSubmitting">
          <span class="loading-spinner" *ngIf="isSubmitting"></span>
          {{ isSubmitting ? 'Submitting...' : 'Submit Grievance' }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal 2: View Grievance Details -->
<div class="modal-overlay" *ngIf="isDetailsModalVisible && selectedGrievance" (click)="closeDetailsModal()">
  <div class="modal-content details-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div>
          <h2 class="modal-title">{{ selectedGrievance.title }}</h2>
          <p class="modal-subtitle">Grievance #{{ selectedGrievance.greivanceID }}</p>
        </div>
        <button class="modal-close-btn" (click)="closeDetailsModal()"><i class="bi bi-x"></i></button>
      </div>

      <div class="modal-meta-bar">
        <span class="status-tag" [ngClass]="'status-' + selectedGrievance.status.toLowerCase().replace(' ', '-')">
            <i class="bi" [ngClass]="{
                'bi-arrow-in-right-circle': selectedGrievance.status === 'Submitted',
                'bi-hourglass-split': selectedGrievance.status === 'In Review',
                'bi-check2-circle': selectedGrievance.status === 'Resolved',
                'bi-x-circle': selectedGrievance.status === 'Closed'
            }"></i> {{ selectedGrievance.status }}
        </span>
        <span class="date-info">Submitted: {{ formatDate(selectedGrievance.createdDate) }}</span>
        <span class="date-info">Submitted By: User #{{ selectedGrievance.submittedBy }}</span>
      </div>

      <div class="details-grid">
        <div class="detail-item">
          <span class="detail-label">Priority</span>
          <strong class="priority-tag" [ngClass]="getPriorityClass(selectedGrievance.priority)">{{ selectedGrievance.priority }}</strong>
        </div>

        <div class="detail-item" *ngIf="selectedGrievanceCategory">
          <span class="detail-label">Category</span>
          <span class="detail-value">{{ selectedGrievanceCategory }}</span>
        </div>

        <div class="detail-item" *ngIf="selectedGrievance?.attachmentFileName">
          <span class="detail-label">Attachment</span>
          <div class="attachment-info">
            <i class="bi bi-paperclip"></i>
            <span class="file-name">{{ selectedGrievance?.attachmentFileName }}</span>
            <span class="file-size" *ngIf="selectedGrievance?.attachmentFileSize">
              ({{ formatFileSize(selectedGrievance.attachmentFileSize!) }})
            </span>
          </div>
        </div>
      </div>

      <div class="details-section">
        <h3>Description</h3>
        <div class="description-content">
          <p>{{ selectedGrievance.description }}</p>
        </div>
      </div>

      <!-- Support Response Section (if available) -->
      <div class="details-section" *ngIf="selectedGrievance.supportResponse">
        <h3>Support Response</h3>
        <div class="support-response">
          <div class="response-header">
            <i class="bi bi-headset"></i>
            <span>Support Team Response</span>
          </div>
          <p>{{ selectedGrievance.supportResponse }}</p>
        </div>
      </div>

      <!-- Resolution Details (if resolved) -->
      <div class="details-section" *ngIf="selectedGrievance.status === 'Resolved'">
        <h3>Resolution Details</h3>
        <div class="resolution-notice">
          <i class="bi bi-check-circle-fill"></i>
          <p>This grievance has been resolved. If you need further assistance, please submit a new grievance.</p>
        </div>
      </div>
  </div>
</div>
